# Bulk Import Notes

Feature: Import multiple notes from TSV/clipboard data into Anki.

## Context

- Audio generation not needed - card templates use TTS fallback when `_audio` fields are empty
- Single `addNote` action already exists in backend
- Need deterministic `number` field for note identification

## Data Format

TSV with columns matching note model fields:

```
korean	english	example_ko	example_en	etymology	notes
꽃밭	flower garden	봄이 되면 우리 집 꽃밭에서 장미가 피어요	When spring comes roses bloom in our flower garden	꽃 + 밭	텃밭 (.syn:vegetable garden)
```

## Number Field

The `number` field is generated by external tooling before import. The bulk import feature accepts TSV data as-is with all fields already populated.

## Implementation Plan

### Phase 1: Backend

**Add `bulkAddNotes` action to `addon/server.py`:**

```python
elif action == "bulkAddNotes":
    deck_name = params["deckName"]
    model_name = params["modelName"]
    notes_data = params["notes"]  # list of {fields: {}, tags: []}

    model = col.models.by_name(model_name)
    deck = col.decks.by_name(deck_name)
    field_names = [f["name"] for f in model["flds"]]

    results = []
    for note_data in notes_data:
        note = col.new_note(model)
        for name, value in note_data["fields"].items():
            if name in field_names:
                note.fields[field_names.index(name)] = value
        note.tags = note_data.get("tags", [])
        col.add_note(note, deck["id"])
        results.append({"noteId": note.id})

    return {"notes": results, "count": len(results)}
```

### Phase 2: Frontend API

**Add to `src/api.ts`:**

```typescript
interface BulkAddNotesInput {
  deckName: string;
  modelName: string;
  notes: Array<{
    fields: Record<string, string>;
    tags?: string[];
  }>;
}

bulkAddNotes: (input: BulkAddNotesInput) => {
  return invoke<{ notes: Array<{ noteId: number }>; count: number }>(
    "bulkAddNotes",
    input
  );
}
```

### Phase 3: Frontend UI

**Option A: Textarea + Parse Button**

Simple modal with:

1. Select model + deck (reuse existing selectors)
2. Paste TSV data into textarea
3. Preview parsed rows in table
4. Import button

**Option B: File Upload**

1. Drag-drop or file picker for `.tsv` file
2. Same preview + import flow

**Recommendation:** Option A for MVP - simpler, matches current workflow of copying from spreadsheet.

### Phase 4: TSV Parsing

```typescript
function parseTSV(tsv: string): Record<string, string>[] {
  const lines = tsv.trim().split('\n');
  const headers = lines[0].split('\t');

  return lines.slice(1).map(line => {
    const values = line.split('\t');
    const row: Record<string, string> = {};
    headers.forEach((h, i) => {
      row[h.trim()] = values[i]?.trim() ?? '';
    });
    return row;
  });
}
```

## UI Mockup

```
┌─────────────────────────────────────────────────────┐
│ Bulk Import Notes                              [X]  │
├─────────────────────────────────────────────────────┤
│ Model: [Korean Vocabulary    ▼]                     │
│ Deck:  [Korean::Custom       ▼]                     │
│ Tags:  [import-2025-12-28, vocab]                   │
│                                                     │
│ Paste TSV data:                                     │
│ ┌─────────────────────────────────────────────────┐ │
│ │ korean	english	example_ko...                    │ │
│ │ 꽃밭	flower garden	봄이 되면...                   │ │
│ │ 정상	peak; summit	등산하면서...                   │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ Preview (18 notes):                                 │
│ ┌─────────────────────────────────────────────────┐ │
│ │ # │ korean  │ english        │ example_ko   │...│ │
│ │ 1 │ 꽃밭    │ flower garden  │ 봄이 되면... │   │ │
│ │ 2 │ 정상    │ peak; summit   │ 등산하면서...│   │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│                        [Cancel]  [Import 18 Notes]  │
└─────────────────────────────────────────────────────┘
```

## File Changes

| File                                    | Change                                  |
| --------------------------------------- | --------------------------------------- |
| `addon/server.py`                       | Add `bulkAddNotes` action               |
| `src/api.ts`                            | Add `bulkAddNotes` API function         |
| `src/components/bulk-import-dialog.tsx` | New: bulk import modal with TSV parsing |
| `src/root.tsx`                          | Add bulk import button to toolbar       |

## Open Questions

1. **Duplicate handling**: What if a note with the same content already exists?
   - Option A: Import anyway (Anki allows duplicate notes)
   - Option B: Check for duplicates and skip/warn

2. **Field mapping**: Require exact TSV header names matching model field names.

3. **Error handling**: If one note fails, skip and continue (report failures at end).

## Feedback

- move this inside one dropdown

```js
          {schema && (
            <>
              <CreateNoteDialog
                schema={schema}
                defaultModel={validModel ? urlModel : undefined}
              />
              <BulkImportDialog
                schema={schema}
                defaultModel={validModel ? urlModel : undefined}
              />
            </>
          )}
```
