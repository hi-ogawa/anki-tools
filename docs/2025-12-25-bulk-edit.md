# Bulk Edit: Flag/Unflag & Suspend/Unsuspend

## Goal

Add ability to select multiple cards and perform bulk operations:

- Set/clear flags (0-7)
- Suspend/unsuspend cards

## Design Decisions

### Multi-select UI

**Option A: Always show checkboxes**

- Checkbox column always visible
- Pros: Immediate access
- Cons: Takes space, visual clutter when not needed

**Option B: Bulk edit mode toggle** (chosen)

- Button to enter "bulk edit mode"
- Shows checkboxes only when active
- Exit mode on action completion or explicit cancel
- Pros: Cleaner default UI, clear mode distinction
- Cons: Extra click to start

### Select All Scope

**Option A: Current page only**

- Header checkbox selects visible rows
- Simple, predictable
- Cons: Tedious for large result sets

**Option B: Current page + "Select all N matching" banner** (chosen)

- Header checkbox selects current page
- When all on page selected, show banner: "All 20 on this page selected. Select all 1,234 matching this search?"
- Click to switch to "all matching" mode
- Backend sends just the query, not IDs (more efficient)
- Pros: Scales to large datasets, Gmail-like familiar UX

**Implementation for "select all matching":**

- Instead of sending cardIds array, send `{ query: string }` to bulk endpoints
- Backend runs query and applies operation to all results
- Avoids sending thousands of IDs over the wire

### Bulk Action UI

**Option A: Floating toolbar** (chosen)

- Appears when items selected
- Shows count + action buttons
- Position: Above table, replacing/alongside existing toolbar
- Pros: Always visible, clear context

**Option B: Context menu**

- Right-click on selection
- Cons: Not discoverable, mobile-unfriendly

### Scope

Cards view only - flag/suspend are card-level properties. In notes view, multi-select won't be available (or could be future enhancement for tags).

## Implementation

### Backend

```python
# addon/server.py - new endpoints
# Support both cardIds array OR query string
bulkSetCardFlags(cardIds?: list[int], query?: str, flag: int) -> int  # returns count
bulkSuspendCards(cardIds?: list[int], query?: str, suspended: bool) -> int  # returns count
```

When `query` provided, backend runs `col.find_cards(query)` to get IDs.

### Frontend

#### 1. API layer (`src/api.ts`)

```typescript
type BulkTarget = { cardIds: number[] } | { query: string };
bulkSetCardFlags: (input: BulkTarget & { flag: number }) => invoke<number>(...)
bulkSuspendCards: (input: BulkTarget & { suspended: boolean }) => invoke<number>(...)
```

#### 2. Table with bulk edit mode (`src/components/browse-table.tsx`)

- New prop `bulkEditMode: boolean` - controls checkbox visibility
- Add checkbox column as first column when in bulk edit mode
- Header checkbox for select all (current page)
- Pass selection up to parent via `onRowSelectionChange` callback

```typescript
// New props
bulkEditMode: boolean;
rowSelection: Record<string, boolean>;
onRowSelectionChange: (selection: Record<string, boolean>) => void;
```

#### 3. Bulk action toolbar (`src/components/bulk-actions.tsx`)

Replaces normal toolbar when in bulk edit mode:

- "Exit" button to leave bulk edit mode
- Selected count display
- "Select all N matching" link (when all on page selected)
- Flag dropdown
- Suspend/Unsuspend buttons

#### 4. Wire up in NotesView (`src/root.tsx`)

- Add `bulkEditMode` state (boolean)
- Add `rowSelection` state (Record<string, boolean>)
- Add `selectAllQuery` state (string | null) - when set, means "all matching"
- Add bulk mutation hooks
- "Bulk Edit" button in toolbar to enter mode
- Exit mode after action or cancel

### State Flow

```
User clicks "Bulk Edit" button
  → bulkEditMode = true, checkboxes appear
  → User clicks checkboxes
  → rowSelection updates
  → User clicks header checkbox (select all on page)
  → Banner appears: "Select all 1,234 matching?"
  → User clicks banner
  → selectAllQuery = fullSearch (query string)
  → User clicks "Suspend"
  → bulkSuspendCards({ query: selectAllQuery })
  → onSuccess: exit bulk mode, refetch
```

## Files to Modify

1. `addon/server.py` - bulk endpoints with query support
2. `src/api.ts` - bulk API methods
3. `src/components/browse-table.tsx` - bulk edit mode, checkbox column
4. `src/components/bulk-actions.tsx` - new toolbar component
5. `src/root.tsx` - bulk edit mode state, selection, mutations

## Testing

E2E test scenarios:

1. Select multiple cards via checkboxes
2. Set flag on selection, verify all updated
3. Suspend selection, verify all suspended
4. Unsuspend selection, verify all unsuspended
5. Select all on page
6. Clear selection

## feedback

- "Bulk Edit" button
  - button feels too "strong"
  - button height seems slightly off
- "Bulk Edit" mode view
  - we can show actions even when none are selected. just disable it.
